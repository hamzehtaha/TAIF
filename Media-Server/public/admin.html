<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - TAIF Media Management System</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d4ff;
            --primary-dark: #0099cc;
            --bg-dark: #1a1a2e;
            --bg-darker: #16213e;
            --bg-card: rgba(0, 0, 0, 0.5);
            --text-light: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #00ff00;
            --error: #ff4444;
            --warning: #ff9900;
            --border: rgba(0, 212, 255, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 2px solid var(--primary);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 11px;
            color: var(--text-muted);
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-left-color: var(--primary);
        }

        .nav-item.active {
            background: rgba(0, 212, 255, 0.2);
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .nav-item .icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .btn-logout {
            width: 100%;
            padding: 8px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #cc0000;
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            height: 60px;
            background: var(--bg-card);
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }

        .page-title {
            font-size: 24px;
            color: var(--primary);
            font-weight: 600;
        }

        .topbar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 18px;
            color: var(--primary);
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00ffff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-list {
            margin-top: 20px;
        }

        .upload-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .upload-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upload-filename {
            font-weight: 500;
            color: var(--primary);
        }

        .upload-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00ffff);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .upload-stages {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .stage-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
        }

        .stage-badge.active {
            background: var(--primary);
            color: #000;
        }

        .stage-badge.completed {
            background: var(--success);
            color: #000;
        }

        .stage-badge.failed {
            background: var(--error);
            color: #fff;
        }

        /* File Configuration */
        .file-config-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .file-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .file-config-title {
            font-weight: 500;
            color: var(--primary);
            font-size: 14px;
        }

        .file-config-size {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-config-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .file-config-fields {
                grid-template-columns: 1fr;
            }
        }

        .stage-badge.completed {
            background: var(--success);
            color: #000;
        }

        .stage-badge.failed {
            background: var(--error);
            color: #fff;
        }

        /* Video Grid/List */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .video-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(0, 212, 255, 0.2);
        }

        .video-thumbnail {
            width: 100%;
            height: 140px;
            background: rgba(0, 212, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .video-info {
            padding: 15px;
        }

        .video-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .video-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .video-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* API Method Badges */
        .method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 55px;
            text-align: center;
        }
        .method-badge.get { background: #61affe; color: white; }
        .method-badge.post { background: #49cc90; color: white; }
        .method-badge.put { background: #fca130; color: white; }
        .method-badge.delete { background: #f93e3e; color: white; }
        .method-badge.patch { background: #50e3c2; color: white; }

        /* Endpoints Page Styles */
        .endpoints-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .endpoint-item {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
        }

        .endpoint-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--primary);
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .endpoint-method {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }

        .endpoint-method.get { background: #61affe; color: white; }
        .endpoint-method.post { background: #49cc90; color: white; }
        .endpoint-method.put { background: #fca130; color: white; }
        .endpoint-method.delete { background: #f93e3e; color: white; }
        .endpoint-method.page { background: #9c27b0; color: white; }
        .endpoint-method.socket { background: #ff6b6b; color: white; }

        .endpoint-path {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
        }

        .endpoint-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .endpoint-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .endpoint-link {
            display: inline-block;
            margin-top: 10px;
            color: var(--primary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .endpoint-link:hover {
            text-decoration: underline;
        }

        .form-control-sm {
            padding: 6px 10px;
            font-size: 13px;
        }

        .api-card code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(0, 212, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-darker);
            border: 2px solid var(--primary);
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
        }

        /* Logs */
        .log-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid var(--primary);
            padding-left: 12px;
        }

        .log-entry.error {
            border-left-color: var(--error);
        }

        .log-entry.warn {
            border-left-color: var(--warning);
        }

        .log-timestamp {
            color: var(--text-muted);
            font-size: 10px;
            margin-bottom: 3px;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-warning {
            background: rgba(255, 153, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-muted { color: var(--text-muted); }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                z-index: 100;
                height: 100vh;
            }

            .sidebar.open {
                transform: translateX(260px);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üìπ TAIF Media Management System</h1>
                <p>Admin Portal</p>
            </div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="navigateTo('upload')">
                    <span class="icon">üì§</span>
                    <span>Upload</span>
                </div>
                <div class="nav-item" onclick="navigateTo('videos')">
                    <span class="icon">üé¨</span>
                    <span>Videos</span>
                </div>
                <div class="nav-item" onclick="navigateTo('testing')">
                    <span class="icon">üß™</span>
                    <span>API Testing</span>
                </div>
                <div class="nav-item" onclick="navigateTo('statistics')">
                    <span class="icon">üìä</span>
                    <span>Statistics</span>
                </div>
                <div class="nav-item" onclick="navigateTo('settings')">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
                <div class="nav-item" onclick="navigateTo('logs')">
                    <span class="icon">üìù</span>
                    <span>Logs</span>
                </div>
                <div class="nav-item" onclick="navigateTo('endpoints')">
                    <span class="icon">üîó</span>
                    <span>Endpoints</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <span>üë§</span>
                    <span id="currentUser">Admin</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <h2 class="page-title" id="pageTitle">Upload Videos</h2>
                <div class="topbar-actions">
                    <div class="status-indicator" style="margin-right: 15px;" title="Auto-refresh every 10 seconds">
                        <span id="refreshIndicator" style="font-size: 14px;">üîÑ</span>
                        <span id="refreshText" style="font-size: 12px; color: var(--text-muted);">Auto</span>
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot" id="connectionStatus"></span>
                        <span id="statusText">Connected</span>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- Upload Page -->
                <div id="uploadPage" class="page active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Upload Videos</h3>
                        </div>
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon">üìÅ</div>
                            <h3>Drop videos here or click to browse</h3>
                            <p class="text-muted">Supports: MP4, MKV, AVI, MOV, WebM</p>
                            <p class="text-muted" style="margin-top: 10px;">Multiple files supported - upload several videos at once</p>
                            <button class="btn btn-primary" style="margin-top: 15px;">Choose Files</button>
                        </div>
                        <input type="file" id="fileInput" accept="video/*" multiple style="display: none;">
                    </div>

                    <!-- File Configuration Section -->
                    <div id="fileConfigContainer" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Configure Selected Files</h3>
                                <p style="font-size: 12px; margin-top: 5px; color: var(--text-muted);">Customize video names and IDs (optional)</p>
                            </div>
                            <div id="fileConfigList" style="padding: 20px;"></div>
                            <div style="padding: 0 20px 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="startUpload()">üì§ Start Upload</button>
                                <button class="btn btn-secondary" onclick="cancelFileSelection()">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Video Progress (Highlighted) -->
                    <div id="currentProgressContainer" class="hidden">
                        <div class="card" style="border: 2px solid var(--primary); background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <h3 class="card-title" style="color: white;">üì§ Current Upload Progress</h3>
                            </div>
                            <div id="currentProgress" style="padding: 20px;">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>

                    <div id="uploadListContainer" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìã All Active Uploads</h3>
                                <span id="activeUploadCount" class="badge" style="background: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 12px;">0</span>
                            </div>
                            <div class="upload-list" id="uploadList"></div>
                        </div>
                    </div>

                    <!-- Transcoding Progress Table -->
                    <div id="transcodingTableContainer" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‚öôÔ∏è Active Transcoding Jobs</h3>
                                <span id="activeTranscodeCount" class="badge" style="background: var(--success); padding: 4px 10px; border-radius: 12px; font-size: 12px;">0</span>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Video ID</th>
                                            <th>Name</th>
                                            <th>Stage</th>
                                            <th>Progress</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transcodingTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Videos Page -->
                <div id="videosPage" class="page">
                    <div class="view-toggle mb-20">
                        <button class="btn btn-secondary btn-sm" id="btnListView" onclick="switchVideoView('list')">üìã List</button>
                        <button class="btn btn-secondary btn-sm active" id="btnGridView" onclick="switchVideoView('grid')">üé¨ Grid</button>
                        <button class="btn btn-primary btn-sm" onclick="refreshVideos()" style="margin-left: auto;">üîÑ Refresh</button>
                    </div>

                    <div id="videoGridView" class="video-grid"></div>
                    <div id="videoListView" class="table-container hidden">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Resolutions</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="videoTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Testing Page -->
                <div id="testingPage" class="page">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">API Testing</h3>
                    
                    <!-- API Cards Grid -->
                    <div class="api-cards-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                        
                        <!-- Videos API Card -->
                        <div class="card api-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <h4 style="margin: 0; color: white;">üìπ Videos</h4>
                            </div>
                            <div style="padding: 15px;">
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/api/videos</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">List all videos with pagination</p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                                        <input type="number" class="form-control form-control-sm" id="api-videos-page" placeholder="Page (1)" min="1" value="1">
                                        <input type="number" class="form-control form-control-sm" id="api-videos-limit" placeholder="Limit (50)" min="1" max="100" value="50">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="apiGetVideos()">üöÄ Send</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/api/video/:id</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Get video details by ID</p>
                                    <input type="text" class="form-control form-control-sm" id="api-video-id" placeholder="Enter video ID" style="margin-bottom: 10px;">
                                    <button class="btn btn-primary btn-sm" onclick="apiGetVideo()">üöÄ Send</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge delete">DELETE</span>
                                        <code>/api/video/:id</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Delete video and all files</p>
                                    <input type="text" class="form-control form-control-sm" id="api-video-delete-id" placeholder="Enter video ID" style="margin-bottom: 10px;">
                                    <button class="btn btn-sm" style="background: var(--error);" onclick="apiDeleteVideo()">üóëÔ∏è Delete</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge post">POST</span>
                                        <code>/api/refresh-cache</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Refresh video cache from disk</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiRefreshCache()">üîÑ Refresh Cache</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics & Health Card -->
                        <div class="card api-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                <h4 style="margin: 0; color: white;">üìä Statistics & Health</h4>
                            </div>
                            <div style="padding: 15px;">
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/api/admin/statistics</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Get comprehensive server statistics</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiGetStatistics()">üöÄ Send</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/health</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Full health check with system info</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiHealthCheck()">üíì Check Health</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/ready</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Kubernetes readiness probe</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiReadyCheck()">‚úÖ Check Ready</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/live</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Kubernetes liveness probe</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiLiveCheck()">üíö Check Live</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Logs API Card -->
                        <div class="card api-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <h4 style="margin: 0; color: white;">üìù Logs</h4>
                            </div>
                            <div style="padding: 15px;">
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/api/admin/logs</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Get server logs with filters</p>
                                    <div style="display: grid; gap: 8px; margin-bottom: 10px;">
                                        <select class="form-control form-control-sm" id="api-logs-level">
                                            <option value="">All Levels</option>
                                            <option value="ERROR">Error</option>
                                            <option value="WARN">Warning</option>
                                            <option value="INFO">Info</option>
                                            <option value="DEBUG">Debug</option>
                                        </select>
                                        <input type="text" class="form-control form-control-sm" id="api-logs-search" placeholder="Search term...">
                                        <input type="number" class="form-control form-control-sm" id="api-logs-limit" placeholder="Limit (100)" min="1" max="1000" value="100">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="apiGetLogs()">üöÄ Send</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge delete">DELETE</span>
                                        <code>/api/admin/logs</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Clear all server logs</p>
                                    <button class="btn btn-sm" style="background: var(--error);" onclick="apiClearLogs()">üóëÔ∏è Clear Logs</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuration API Card -->
                        <div class="card api-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <h4 style="margin: 0; color: white;">‚öôÔ∏è Configuration</h4>
                            </div>
                            <div style="padding: 15px;">
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge get">GET</span>
                                        <code>/api/admin/config</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Get current server configuration</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiGetConfig()">üöÄ Send</button>
                                </div>
                                
                                <hr style="border-color: var(--border); margin: 15px 0;">
                                
                                <div class="api-endpoint-item">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <span class="method-badge post">POST</span>
                                        <code>/api/admin/config/test</code>
                                    </div>
                                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Validate configuration without saving</p>
                                    <button class="btn btn-primary btn-sm" onclick="apiTestConfig()">üß™ Test Config</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Request Card -->
                        <div class="card api-card" style="grid-column: span 2;">
                            <div class="card-header" style="background: linear-gradient(135deg, #434343 0%, #000000 100%);">
                                <h4 style="margin: 0; color: white;">üîß Custom Request</h4>
                            </div>
                            <div style="padding: 15px;">
                                <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 15px;">Send a custom API request with full control over method, headers, and body</p>
                                
                                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; margin-bottom: 15px;">
                                    <select class="form-control" id="apiMethod">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                        <option value="PATCH">PATCH</option>
                                    </select>
                                    <input type="text" class="form-control" id="apiEndpoint" placeholder="/api/videos" value="/api/videos">
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label class="form-label">Headers (JSON)</label>
                                        <textarea class="form-control" id="apiHeaders" rows="4" placeholder='{"Content-Type": "application/json"}'>{}</textarea>
                                    </div>
                                    <div>
                                        <label class="form-label">Body (JSON)</label>
                                        <textarea class="form-control" id="apiBody" rows="4" placeholder='{"key": "value"}'></textarea>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" onclick="executeApiTest()">üöÄ Send Request</button>
                                <button class="btn btn-secondary" onclick="clearApiTest()" style="margin-left: 10px;">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Response Section -->
                    <div id="apiResults" class="hidden" style="margin-top: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h4 style="margin: 0;">Response</h4>
                                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('apiResults').classList.add('hidden')">‚úñ Close</button>
                            </div>
                            <div style="padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                    <div>
                                        <strong>Status:</strong> 
                                        <span id="responseStatus" style="font-size: 18px; font-weight: bold; margin-left: 5px;"></span>
                                        <span id="responseStatusText" style="margin-left: 10px; color: var(--text-muted);"></span>
                                    </div>
                                    <div>
                                        <strong>Time:</strong> <span id="responseTime">--</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <details>
                                        <summary style="cursor: pointer; color: var(--primary);">Response Headers</summary>
                                        <pre id="responseHeaders" style="margin-top: 10px; color: var(--text-muted); font-size: 11px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;"></pre>
                                    </details>
                                </div>
                                <div>
                                    <strong>Body:</strong>
                                    <pre id="responseBody" style="margin-top: 10px; color: var(--text-light); overflow-x: auto; max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Page -->
                <div id="statisticsPage" class="page">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Server Statistics</h3>
                    <div class="stats-grid" id="statsServer">
                        <div class="stat-card">
                            <div class="stat-value" id="statUptime">--</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statMemory">--</div>
                            <div class="stat-label">Memory Usage</div>
                        </div>
                    </div>

                    <h3 style="color: var(--primary); margin-bottom: 20px; margin-top: 30px;">Media Statistics</h3>
                    <div class="stats-grid" id="statsMedia">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalVideos">0</div>
                            <div class="stat-label">Total Videos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statActiveUploads">0</div>
                            <div class="stat-label">Active Uploads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statActiveTranscodes">0</div>
                            <div class="stat-label">Active Transcodes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statActiveStreams">0</div>
                            <div class="stat-label">Active Streams</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalStreams">0</div>
                            <div class="stat-label">Total Streams Served</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statDiskUsage">0 GB</div>
                            <div class="stat-label">Disk Usage</div>
                        </div>
                    </div>

                    <h3 style="color: var(--primary); margin-bottom: 20px; margin-top: 30px;">Performance Metrics</h3>
                    <div class="stats-grid" id="statsPerformance">
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgUpload">--</div>
                            <div class="stat-label">Avg Upload Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgTranscode">--</div>
                            <div class="stat-label">Avg Transcode Time</div>
                        </div>
                    </div>

                    <button class="btn btn-primary mt-20" onclick="refreshStats()">üîÑ Refresh Statistics</button>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Server Configuration</h3>
                        </div>

                        <div id="settingsAlert"></div>

                        <form id="settingsForm">
                            <div class="form-group">
                                <label class="form-label">Upload Directory (Read-only)</label>
                                <input type="text" class="form-control" id="settingUploadDir" readonly>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Stream Directory (Read-only)</label>
                                <input type="text" class="form-control" id="settingStreamDir" readonly>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Max Upload Size (bytes)</label>
                                <input type="number" class="form-control" id="settingMaxSize" min="1">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Allowed Formats (comma-separated)</label>
                                <input type="text" class="form-control" id="settingFormats">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Transcoding Presets (comma-separated)</label>
                                <input type="text" class="form-control" id="settingPresets">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Enable Transcoding</label>
                                <select class="form-control" id="settingEnableTranscoding">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div id="configValidationResults" class="hidden" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3);"></div>

                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="testConfiguration()">üß™ Test Configuration</button>
                                <button type="button" class="btn btn-primary" onclick="saveSettings()">üíæ Save Configuration</button>
                                <button type="button" class="btn btn-secondary" onclick="loadSettings()">üîÑ Reset</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Logs Page -->
                <div id="logsPage" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Server Logs</h3>
                        </div>

                        <div class="log-filters">
                            <div class="form-group" style="margin: 0;">
                                <select class="form-control" id="logLevelFilter" onchange="loadLogs()">
                                    <option value="">All Levels</option>
                                    <option value="ERROR">Error</option>
                                    <option value="WARN">Warning</option>
                                    <option value="INFO">Info</option>
                                    <option value="DEBUG">Debug</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0; flex: 1;">
                                <input type="text" class="form-control" id="logSearch" placeholder="Search logs..." onkeyup="loadLogs()">
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="loadLogs()">üîÑ Refresh</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearLogs()">üóëÔ∏è Clear</button>
                        </div>

                        <div class="log-container" id="logContainer">
                            <div class="text-muted text-center">Loading logs...</div>
                        </div>
                    </div>
                </div>

                <!-- Endpoints Page -->
                <div id="endpointsPage" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Available Endpoints</h3>
                        </div>
                        <p class="text-muted" style="padding: 0 20px; margin-bottom: 15px;">Complete list of all available API endpoints, pages, and resources in this server.</p>
                        
                        <!-- Pages Section -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üìÑ Web Pages</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method page">PAGE</span>
                                        <span class="endpoint-path">/</span>
                                    </div>
                                    <div class="endpoint-name">Server Status</div>
                                    <div class="endpoint-desc">Homepage showing server health status, uptime, storage usage, and quick links.</div>
                                    <a href="/" target="_blank" class="endpoint-link">Open ‚Üí</a>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method page">PAGE</span>
                                        <span class="endpoint-path">/admin</span>
                                    </div>
                                    <div class="endpoint-name">Admin Portal</div>
                                    <div class="endpoint-desc">Full-featured administration panel for managing videos, uploads, settings, and monitoring.</div>
                                    <a href="/admin" target="_blank" class="endpoint-link">Open ‚Üí</a>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method page">PAGE</span>
                                        <span class="endpoint-path">/login</span>
                                    </div>
                                    <div class="endpoint-name">Login Page</div>
                                    <div class="endpoint-desc">Authentication page for admin access.</div>
                                    <a href="/login" target="_blank" class="endpoint-link">Open ‚Üí</a>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method page">PAGE</span>
                                        <span class="endpoint-path">/player</span>
                                    </div>
                                    <div class="endpoint-name">Video Player</div>
                                    <div class="endpoint-desc">Standalone video player page with quality selection and playback controls.</div>
                                    <a href="/player" target="_blank" class="endpoint-link">Open ‚Üí</a>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method page">PAGE</span>
                                        <span class="endpoint-path">/api-docs</span>
                                    </div>
                                    <div class="endpoint-name">API Documentation (Swagger)</div>
                                    <div class="endpoint-desc">Interactive API documentation with try-it-out functionality.</div>
                                    <a href="/api-docs" target="_blank" class="endpoint-link">Open ‚Üí</a>
                                </div>
                            </div>
                        </div>

                        <!-- Health Endpoints -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üíì Health & Status</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/health</span>
                                    </div>
                                    <div class="endpoint-name">Health Check</div>
                                    <div class="endpoint-desc">Returns server health status (healthy/degraded/unhealthy).</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/ready</span>
                                    </div>
                                    <div class="endpoint-name">Readiness Check</div>
                                    <div class="endpoint-desc">Kubernetes readiness probe - indicates if server is ready to accept requests.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/live</span>
                                    </div>
                                    <div class="endpoint-name">Liveness Check</div>
                                    <div class="endpoint-desc">Kubernetes liveness probe - indicates if server is alive.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Auth Endpoints -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üîê Authentication</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method post">POST</span>
                                        <span class="endpoint-path">/api/auth/login</span>
                                    </div>
                                    <div class="endpoint-name">Login</div>
                                    <div class="endpoint-desc">Authenticate with username and password. Returns JWT token.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method post">POST</span>
                                        <span class="endpoint-path">/api/auth/logout</span>
                                    </div>
                                    <div class="endpoint-name">Logout</div>
                                    <div class="endpoint-desc">Invalidate current session and clear auth cookie.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/auth/verify</span>
                                    </div>
                                    <div class="endpoint-name">Verify Token</div>
                                    <div class="endpoint-desc">Verify if the current JWT token is valid.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Video Endpoints -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üé¨ Videos</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/videos</span>
                                    </div>
                                    <div class="endpoint-name">List Videos</div>
                                    <div class="endpoint-desc">Get paginated list of all videos with metadata. Supports ?page, ?limit, ?sort, ?order params.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/video/:id</span>
                                    </div>
                                    <div class="endpoint-name">Get Video Details</div>
                                    <div class="endpoint-desc">Get detailed information about a specific video including available presets.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/video-ids</span>
                                    </div>
                                    <div class="endpoint-name">Get Video IDs</div>
                                    <div class="endpoint-desc">Get list of all video IDs (for duplicate checking).</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method post">POST</span>
                                        <span class="endpoint-path">/api/upload</span>
                                    </div>
                                    <div class="endpoint-name">Upload Video</div>
                                    <div class="endpoint-desc">Upload a new video file. Accepts multipart/form-data with optional videoId and presets params.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method delete">DELETE</span>
                                        <span class="endpoint-path">/api/video/:id</span>
                                    </div>
                                    <div class="endpoint-name">Delete Video</div>
                                    <div class="endpoint-desc">Delete a video and all its transcoded files.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method post">POST</span>
                                        <span class="endpoint-path">/api/refresh-cache</span>
                                    </div>
                                    <div class="endpoint-name">Refresh Video Cache</div>
                                    <div class="endpoint-desc">Reload video metadata from disk (useful after manual file changes).</div>
                                </div>
                            </div>
                        </div>

                        <!-- Streaming Endpoints -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üì∫ Streaming</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/stream/:videoId/:quality</span>
                                    </div>
                                    <div class="endpoint-name">Stream Video</div>
                                    <div class="endpoint-desc">Stream video file with range request support. Quality: 360p.mp4, 480p.mp4, 720p.mp4, 1080p.mp4</div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Endpoints -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">‚öôÔ∏è Administration</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/admin/statistics</span>
                                    </div>
                                    <div class="endpoint-name">Get Statistics</div>
                                    <div class="endpoint-desc">Server statistics including uptime, memory, disk usage, video counts.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/admin/config</span>
                                    </div>
                                    <div class="endpoint-name">Get Configuration</div>
                                    <div class="endpoint-desc">Current server configuration settings.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method put">PUT</span>
                                        <span class="endpoint-path">/api/admin/config</span>
                                    </div>
                                    <div class="endpoint-name">Update Configuration</div>
                                    <div class="endpoint-desc">Update modifiable server settings (transcoding presets, cleanup interval).</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method post">POST</span>
                                        <span class="endpoint-path">/api/admin/config/test</span>
                                    </div>
                                    <div class="endpoint-name">Validate Configuration</div>
                                    <div class="endpoint-desc">Test configuration values without applying them.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method get">GET</span>
                                        <span class="endpoint-path">/api/admin/logs</span>
                                    </div>
                                    <div class="endpoint-name">Get Logs</div>
                                    <div class="endpoint-desc">Retrieve server logs. Supports ?level and ?search params.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method delete">DELETE</span>
                                        <span class="endpoint-path">/api/admin/logs</span>
                                    </div>
                                    <div class="endpoint-name">Clear Logs</div>
                                    <div class="endpoint-desc">Clear all stored server logs.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Socket.IO Events -->
                        <div style="padding: 0 20px 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üîå Socket.IO Events</h4>
                            <div class="endpoints-list">
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method socket">EVENT</span>
                                        <span class="endpoint-path">upload:progress</span>
                                    </div>
                                    <div class="endpoint-name">Upload Progress</div>
                                    <div class="endpoint-desc">Real-time upload progress updates with percentage and bytes uploaded.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method socket">EVENT</span>
                                        <span class="endpoint-path">transcode:progress</span>
                                    </div>
                                    <div class="endpoint-name">Transcode Progress</div>
                                    <div class="endpoint-desc">Real-time transcoding progress for each quality preset.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method socket">EVENT</span>
                                        <span class="endpoint-path">transcode:complete</span>
                                    </div>
                                    <div class="endpoint-name">Transcode Complete</div>
                                    <div class="endpoint-desc">Notification when video transcoding is finished.</div>
                                </div>
                                <div class="endpoint-item">
                                    <div class="endpoint-header">
                                        <span class="endpoint-method socket">EVENT</span>
                                        <span class="endpoint-path">progress:snapshot</span>
                                    </div>
                                    <div class="endpoint-name">Progress Snapshot</div>
                                    <div class="endpoint-desc">Sent on connect with current upload/transcode state for late-joining clients.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Video Player Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="modalVideoTitle">Video Player</h3>
                <button class="modal-close" onclick="closeVideoModal()">‚úñ</button>
            </div>
            <video id="modalVideoPlayer" controls style="width: 100%; max-height: 500px; background: #000;"></video>
            <div style="margin-top: 15px;">
                <label class="form-label">Quality:</label>
                <select class="form-control" id="modalQualitySelect" onchange="changeVideoQuality()"></select>
            </div>
        </div>
    </div>

    <script>
        // Authentication
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/login';
        }

        // Verify token
        fetch('/api/auth/verify', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                localStorage.clear();
                window.location.href = '/login';
            } else {
                const username = localStorage.getItem('username') || 'Admin';
                document.getElementById('currentUser').textContent = username;
            }
        })
        .catch(() => {
            localStorage.clear();
            window.location.href = '/login';
        });

        // Socket.IO
        let socket;
        const activeUploads = new Map();
        const activeTranscodes = new Map(); // Track transcoding jobs separately
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function initSocket() {
            socket = io(window.location.origin, {
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: maxReconnectAttempts
            });

            socket.on('connect', () => {
                document.getElementById('statusText').textContent = 'Connected';
                document.getElementById('connectionStatus').style.background = 'var(--success)';
                reconnectAttempts = 0;
            });

            socket.on('disconnect', () => {
                document.getElementById('statusText').textContent = 'Disconnected';
                document.getElementById('connectionStatus').style.background = 'var(--error)';
            });

            socket.on('reconnect_attempt', (attemptNumber) => {
                reconnectAttempts = attemptNumber;
                document.getElementById('statusText').textContent = `Reconnecting (${attemptNumber}/${maxReconnectAttempts})...`;
                document.getElementById('connectionStatus').style.background = 'var(--warning)';
            });

            socket.on('reconnect_failed', () => {
                document.getElementById('statusText').textContent = 'Connection Failed';
                document.getElementById('connectionStatus').style.background = 'var(--error)';
                showAlert('Lost connection to server. Please refresh the page.', 'error');
            });

            // NEW: Receive progress snapshot for late-joining clients
            socket.on('progress:snapshot', (snapshot) => {
                console.log('Received progress snapshot:', snapshot);
                
                // Restore upload progress
                if (snapshot.uploads && Array.isArray(snapshot.uploads)) {
                    snapshot.uploads.forEach(upload => {
                        // Only restore to active uploads if still in progress
                        if (upload.status === 'uploading' || upload.status === 'uploaded') {
                            const uploadItem = {
                                id: upload.uploadId,
                                uploadId: upload.uploadId,
                                videoId: upload.videoId,
                                filename: upload.videoName,
                                customName: upload.videoName,
                                size: upload.totalBytes,
                                progress: upload.percent,
                                stage: 'uploaded',
                                message: 'Upload completed'
                            };
                            activeUploads.set(upload.uploadId, uploadItem);
                            
                            // Subscribe to updates for this upload
                            socket.emit('upload:subscribe', upload.uploadId);
                        }
                    });
                }
                
                // Restore transcode progress
                if (snapshot.transcodes && Array.isArray(snapshot.transcodes)) {
                    snapshot.transcodes.forEach(transcode => {
                        if (transcode.currentStage !== 'completed' && transcode.currentStage !== 'failed') {
                            activeTranscodes.set(transcode.uploadId, {
                                uploadId: transcode.uploadId,
                                videoId: transcode.videoId,
                                filename: transcode.videoName,
                                stage: transcode.currentStage,
                                progress: transcode.overallProgressPercent,
                                stageProgress: transcode.stageProgressPercent,
                                message: `Transcoding ${transcode.currentStage.replace('transcoding_', '')}`,
                                timestamp: Date.now()
                            });
                            
                            // Also update the upload item if exists
                            const uploadItem = activeUploads.get(transcode.uploadId);
                            if (uploadItem) {
                                uploadItem.stage = transcode.currentStage.replace('_', '-');
                                uploadItem.progress = transcode.overallProgressPercent;
                                uploadItem.message = `Transcoding ${transcode.currentStage.replace('transcoding_', '')}`;
                            }
                            
                            // Subscribe to updates for this transcode
                            socket.emit('upload:subscribe', transcode.uploadId);
                        }
                    });
                }
                
                renderUploadList();
                renderTranscodingTable();
            });

            // NEW: Upload progress events
            socket.on('upload:progress', (progress) => {
                console.log('Upload progress:', progress);
                handleUploadProgress(progress);
            });

            socket.on('upload:completed', (progress) => {
                console.log('Upload completed:', progress);
                handleUploadProgress(progress);
            });

            socket.on('upload:failed', (progress) => {
                console.log('Upload failed:', progress);
                handleUploadProgress(progress);
            });

            // NEW: Transcode events
            socket.on('transcode:started', (progress) => {
                console.log('Transcode started:', progress);
                handleTranscodeProgress(progress);
            });

            socket.on('transcode:progress', (progress) => {
                console.log('Transcode progress:', progress);
                handleTranscodeProgress(progress);
            });

            socket.on('transcode:completed', (progress) => {
                console.log('Transcode completed:', progress);
                handleTranscodeProgress(progress);
                
                // Clean up after delay
                setTimeout(() => {
                    activeUploads.delete(progress.uploadId);
                    activeTranscodes.delete(progress.uploadId);
                    renderUploadList();
                    renderTranscodingTable();
                    
                    if (activeUploads.size === 0) {
                        document.getElementById('uploadListContainer').classList.add('hidden');
                    }
                    
                    // Refresh videos if on that page
                    if (document.getElementById('videosPage').classList.contains('active')) {
                        loadVideos();
                    }
                }, 5000);
            });

            socket.on('transcode:failed', (progress) => {
                console.log('Transcode failed:', progress);
                handleTranscodeProgress(progress);
            });

            socket.on('stats-update', (stats) => {
                if (document.getElementById('statisticsPage').classList.contains('active')) {
                    updateStatsDisplay(stats);
                }
            });

            socket.on('system-notification', (notification) => {
                showAlert(notification.message, notification.type);
            });
        }

        initSocket();

        function handleUploadProgress(progress) {
            // Find or create upload item
            let uploadItem = activeUploads.get(progress.uploadId);
            if (!uploadItem) {
                uploadItem = {
                    id: progress.uploadId,
                    uploadId: progress.uploadId,
                    videoId: progress.videoId,
                    filename: progress.videoName,
                    customName: progress.videoName,
                    size: progress.totalBytes,
                    progress: progress.percent,
                    stage: progress.status,
                    message: `Upload: ${progress.percent}%`
                };
                activeUploads.set(progress.uploadId, uploadItem);
            } else {
                uploadItem.progress = progress.percent;
                uploadItem.stage = progress.status;
                uploadItem.message = progress.status === 'uploaded' ? 'Upload complete' : `Upload: ${progress.percent}%`;
                if (progress.error) {
                    uploadItem.message = `Error: ${progress.error}`;
                    uploadItem.stage = 'failed';
                }
            }
            
            renderUploadList();
        }

        function handleTranscodeProgress(progress) {
            // Update transcode table
            if (progress.currentStage && progress.currentStage !== 'idle') {
                activeTranscodes.set(progress.uploadId, {
                    uploadId: progress.uploadId,
                    videoId: progress.videoId,
                    filename: progress.videoName,
                    stage: progress.currentStage,
                    progress: progress.overallProgressPercent,
                    stageProgress: progress.stageProgressPercent,
                    message: progress.currentStage === 'completed' ? 'Complete!' :
                             progress.currentStage === 'failed' ? `Error: ${progress.error || 'Unknown'}` :
                             `${progress.currentStage.replace('transcoding_', '').toUpperCase()}: ${progress.stageProgressPercent}%`,
                    timestamp: Date.now()
                });
                renderTranscodingTable();
            }
            
            // Update upload item
            const uploadItem = activeUploads.get(progress.uploadId);
            if (uploadItem) {
                uploadItem.progress = progress.overallProgressPercent;
                uploadItem.stage = progress.currentStage.replace('_', '-');
                uploadItem.message = progress.currentStage === 'completed' ? 'Transcoding complete!' :
                                   progress.currentStage === 'failed' ? `Error: ${progress.error || 'Unknown'}` :
                                   `Transcoding ${progress.currentStage.replace('transcoding_', '')}: ${progress.stageProgressPercent}%`;
                
                if (progress.currentFps) {
                    uploadItem.message += ` (${progress.currentFps} fps)`;
                }
                
                renderUploadList();
            }
            
            // Clean up on completion or failure
            if (progress.currentStage === 'completed' || progress.currentStage === 'failed') {
                setTimeout(() => {
                    activeTranscodes.delete(progress.uploadId);
                    renderTranscodingTable();
                }, 3000);
            }
        }

        function renderTranscodingTable() {
            const container = document.getElementById('transcodingTableContainer');
            const tbody = document.getElementById('transcodingTableBody');
            const countBadge = document.getElementById('activeTranscodeCount');

            if (countBadge) countBadge.textContent = activeTranscodes.size;

            if (activeTranscodes.size === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            tbody.innerHTML = '';

            for (let [uploadId, job] of activeTranscodes) {
                const stageName = job.stage.replace('transcoding_', '').toUpperCase();
                const statusColor = job.progress >= 100 ? 'var(--success)' : 
                                  job.stage === 'failed' ? 'var(--error)' : 'var(--primary)';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: monospace; font-size: 11px;">${escapeHtml(job.videoId ? job.videoId.substring(0, 8) : uploadId.substring(0, 8))}...</td>
                    <td>${escapeHtml(job.filename)}</td>
                    <td><span class="stage-badge ${job.stage === 'failed' ? 'failed' : 'active'}">${stageName}</span></td>
                    <td>
                        <div class="progress-bar" style="height: 18px; margin: 0;">
                            <div class="progress-fill" style="width: ${job.progress}%">${job.progress}%</div>
                        </div>
                    </td>
                    <td style="color: ${statusColor};">${escapeHtml(job.message)}</td>
                `;
                tbody.appendChild(row);
            }
        }

        // Helper for auth requests
        function authFetch(url, options = {}) {
            const headers = options.headers || {};
            headers['Authorization'] = `Bearer ${authToken}`;
            return fetch(url, { ...options, headers });
        }

        // Navigation
        const pages = {
            'upload': { title: 'Upload Videos', element: 'uploadPage' },
            'videos': { title: 'Video Library', element: 'videosPage' },
            'testing': { title: 'API Testing', element: 'testingPage' },
            'statistics': { title: 'Statistics', element: 'statisticsPage' },
            'settings': { title: 'Settings', element: 'settingsPage' },
            'logs': { title: 'Logs', element: 'logsPage' },
            'endpoints': { title: 'API Endpoints', element: 'endpointsPage' }
        };

        // Auto-refresh variables (declared early so navigateTo can use them)
        let autoRefreshInterval = null;
        let currentPage = 'upload';

        function navigateTo(pageName) {
            // Track current page for auto-refresh
            currentPage = pageName;
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
            });
            if (event && event.target) {
                var navItem = event.target.closest('.nav-item');
                if (navItem) navItem.classList.add('active');
            }

            // Update page title
            document.getElementById('pageTitle').textContent = pages[pageName].title;

            // Show page
            document.querySelectorAll('.page').forEach(function(page) {
                page.classList.remove('active');
            });
            document.getElementById(pages[pageName].element).classList.add('active');

            // Load page data
            if (pageName === 'videos') loadVideos();
            if (pageName === 'statistics') refreshStats();
            if (pageName === 'settings') loadSettings();
            if (pageName === 'logs') loadLogs();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Upload functionality
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        let selectedFiles = [];

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            selectedFiles = Array.from(files);
            showFileConfiguration();
            fileInput.value = '';
        }

        // Cache for existing video IDs (for duplicate checking)
        let existingVideoIds = new Set();

        // Fetch existing video IDs for duplicate checking
        async function fetchExistingVideoIds() {
            try {
                const res = await authFetch('/api/video-ids');
                const data = await res.json();
                if (data.success && data.data.ids) {
                    existingVideoIds = new Set(data.data.ids);
                }
            } catch (e) {
                console.error('Failed to fetch video IDs:', e);
            }
        }

        function showFileConfiguration() {
            // Fetch existing video IDs first
            fetchExistingVideoIds();
            
            const container = document.getElementById('fileConfigList');
            container.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-config-item';
                fileItem.innerHTML = `
                    <div class="file-config-header">
                        <div>
                            <div class="file-config-title">üìπ ${escapeHtml(file.name)}</div>
                            <div class="file-config-size">${formatBytes(file.size)}</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="removeFile(${index})">‚ùå Remove</button>
                    </div>
                    <div class="file-config-fields">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Custom Video Name (Optional)</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="videoName-${index}"
                                placeholder="${escapeHtml(file.name)}"
                                style="font-size: 13px;">
                            <small style="color: var(--text-muted); font-size: 11px;">Display name for this video</small>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Custom Video ID (Optional)</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="videoId-${index}"
                                placeholder="Auto-generated"
                                pattern="[a-zA-Z0-9_-]+"
                                oninput="validateVideoId(this, ${index})"
                                style="font-size: 13px;">
                            <small id="videoIdError-${index}" style="color: var(--error); font-size: 11px; display: none;"></small>
                            <small id="videoIdHelp-${index}" style="color: var(--text-muted); font-size: 11px;">Alphanumeric, hyphens, underscores only</small>
                        </div>
                    </div>
                `;
                container.appendChild(fileItem);
            });

            document.getElementById('fileConfigContainer').classList.remove('hidden');
        }

        // Validate video ID with real-time duplicate checking
        function validateVideoId(input, index) {
            const value = input.value.trim();
            const errorEl = document.getElementById(`videoIdError-${index}`);
            const helpEl = document.getElementById(`videoIdHelp-${index}`);
            
            if (!value) {
                errorEl.style.display = 'none';
                helpEl.style.display = 'block';
                input.style.borderColor = '';
                return true;
            }
            
            // Check format (must match server regex exactly)
            if (!/^[a-zA-Z0-9_-]+$/.test(value)) {
                errorEl.textContent = 'Invalid format. Use only letters, numbers, hyphens, and underscores.';
                errorEl.style.display = 'block';
                helpEl.style.display = 'none';
                input.style.borderColor = 'var(--error)';
                return false;
            }
            
            // Check for duplicate in existing videos
            if (existingVideoIds.has(value)) {
                errorEl.textContent = `Video ID "${value}" already exists on server.`;
                errorEl.style.display = 'block';
                helpEl.style.display = 'none';
                input.style.borderColor = 'var(--error)';
                return false;
            }
            
            // Check for duplicate within current batch
            const batchIds = [];
            for (let i = 0; i < selectedFiles.length; i++) {
                if (i !== index) {
                    const otherInput = document.getElementById(`videoId-${i}`);
                    if (otherInput && otherInput.value.trim()) {
                        batchIds.push(otherInput.value.trim());
                    }
                }
            }
            
            if (batchIds.includes(value)) {
                errorEl.textContent = 'Duplicate ID in current batch. Each video needs a unique ID.';
                errorEl.style.display = 'block';
                helpEl.style.display = 'none';
                input.style.borderColor = 'var(--error)';
                return false;
            }
            
            errorEl.style.display = 'none';
            helpEl.style.display = 'block';
            input.style.borderColor = 'var(--success)';
            return true;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            if (selectedFiles.length === 0) {
                cancelFileSelection();
            } else {
                showFileConfiguration();
            }
        }

        function cancelFileSelection() {
            selectedFiles = [];
            document.getElementById('fileConfigContainer').classList.add('hidden');
        }

        function startUpload() {
            if (selectedFiles.length === 0) return;

            // Validate all video IDs before starting upload
            let hasErrors = false;
            const videoIds = [];
            
            for (let index = 0; index < selectedFiles.length; index++) {
                const videoIdInput = document.getElementById(`videoId-${index}`);
                const videoId = videoIdInput?.value.trim();
                
                if (videoId) {
                    // Check format
                    if (!/^[a-zA-Z0-9_-]+$/.test(videoId)) {
                        showAlert(`Invalid video ID format for "${selectedFiles[index].name}". Use only letters, numbers, hyphens, and underscores.`, 'error');
                        hasErrors = true;
                        break;
                    }
                    
                    // Check for server duplicate
                    if (existingVideoIds.has(videoId)) {
                        showAlert(`Video ID "${videoId}" already exists on server.`, 'error');
                        hasErrors = true;
                        break;
                    }
                    
                    // Check for batch duplicate
                    if (videoIds.includes(videoId)) {
                        showAlert(`Duplicate video ID "${videoId}" in upload batch.`, 'error');
                        hasErrors = true;
                        break;
                    }
                    
                    videoIds.push(videoId);
                }
            }
            
            if (hasErrors) return;

            // Hide config, show upload list
            document.getElementById('fileConfigContainer').classList.add('hidden');
            document.getElementById('uploadListContainer').classList.remove('hidden');

            // Upload each file with staggered timing
            selectedFiles.forEach((file, index) => {
                const videoName = document.getElementById(`videoName-${index}`)?.value.trim();
                const videoId = document.getElementById(`videoId-${index}`)?.value.trim();

                setTimeout(() => {
                    uploadVideo(file, videoName, videoId);
                }, index * 500); // Stagger uploads by 500ms
            });

            selectedFiles = [];
        }

        function uploadVideo(file, customName = '', customId = '') {
            const uploadId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const uploadItem = {
                id: uploadId,
                uploadId: uploadId,
                filename: file.name,
                customName: customName || file.name,
                size: file.size,
                progress: 0,
                stage: 'preparing',
                message: 'Preparing upload...'
            };

            activeUploads.set(uploadId, uploadItem);
            renderUploadItem(uploadItem);

            const formData = new FormData();
            formData.append('video', file);
            if (customName) formData.append('videoName', customName);
            if (customId) formData.append('videoId', customId);

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    uploadItem.progress = percent;
                    uploadItem.stage = 'uploading';
                    uploadItem.message = `Uploading: ${formatBytes(e.loaded)} / ${formatBytes(e.total)}`;
                    updateUploadItem(uploadItem);
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            const videoId = data.data.videoId;
                            const uploadIdFromServer = data.data.uploadId;
                            
                            // Update local upload item with server IDs
                            uploadItem.videoId = videoId;
                            uploadItem.uploadIdFromServer = uploadIdFromServer;
                            uploadItem.stage = 'uploaded';
                            uploadItem.message = 'Upload complete, processing...';
                            uploadItem.progress = 100;
                            
                            // Replace local ID with server uploadId
                            activeUploads.delete(uploadId);
                            uploadItem.id = uploadIdFromServer;
                            uploadItem.uploadId = uploadIdFromServer;
                            activeUploads.set(uploadIdFromServer, uploadItem);
                            
                            updateUploadItem(uploadItem);

                            // Subscribe to progress updates using server's uploadId
                            socket.emit('upload:subscribe', uploadIdFromServer);
                        } else {
                            uploadItem.stage = 'failed';
                            uploadItem.message = data.message || 'Upload failed';
                            updateUploadItem(uploadItem);
                        }
                    } catch (e) {
                        uploadItem.stage = 'failed';
                        uploadItem.message = 'Error parsing response';
                        updateUploadItem(uploadItem);
                    }
                } else {
                    uploadItem.stage = 'failed';
                    uploadItem.message = `Upload failed: ${xhr.statusText}`;
                    updateUploadItem(uploadItem);
                }
            });

            xhr.addEventListener('error', () => {
                uploadItem.stage = 'failed';
                uploadItem.message = 'Network error';
                updateUploadItem(uploadItem);
            });

            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }

        function renderUploadItem(uploadItem) {
            renderUploadList();
        }

        function updateUploadItem(uploadItem) {
            renderUploadList();
        }

        function renderUploadList() {
            const container = document.getElementById('uploadList');
            const listContainer = document.getElementById('uploadListContainer');
            const currentProgressContainer = document.getElementById('currentProgressContainer');
            const currentProgress = document.getElementById('currentProgress');
            
            // Update count badges
            const countBadge = document.getElementById('activeUploadCount');
            if (countBadge) countBadge.textContent = activeUploads.size;
            
            // Show or hide the container based on active uploads
            if (activeUploads.size === 0) {
                listContainer.classList.add('hidden');
                currentProgressContainer.classList.add('hidden');
                container.innerHTML = '';
                currentProgress.innerHTML = '';
                return;
            }
            
            listContainer.classList.remove('hidden');
            container.innerHTML = '';
            
            // Find the most recent active upload (not completed or failed) for featured display
            let currentItem = null;
            for (let [id, item] of activeUploads) {
                if (item.stage !== 'completed' && item.stage !== 'failed') {
                    currentItem = item;
                    break;
                }
            }
            
            // Render current progress section
            if (currentItem) {
                currentProgressContainer.classList.remove('hidden');
                const stages = ['360p', '480p', '720p', '1080p'];
                const displayName = currentItem.customName || currentItem.filename;
                
                let currentResolution = null;
                if (currentItem.stage && currentItem.stage.includes('transcoding')) {
                    const match = currentItem.stage.match(/transcoding[-_](\d+p)/);
                    if (match) currentResolution = match[1];
                }
                
                currentProgress.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--text-light);">${escapeHtml(displayName)}</div>
                            <div style="color: var(--text-muted); font-size: 13px; margin-top: 5px;">${formatBytes(currentItem.size || 0)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${currentItem.progress || 0}%</div>
                            <div style="color: var(--text-muted); font-size: 12px;">${currentItem.stage || 'preparing'}</div>
                        </div>
                    </div>
                    <div class="progress-bar" style="height: 24px; margin-bottom: 15px;">
                        <div class="progress-fill" style="width: ${currentItem.progress || 0}%; font-size: 13px;">${currentItem.message || 'Preparing...'}</div>
                    </div>
                    <div class="upload-stages" style="justify-content: center; gap: 15px;">
                        ${stages.map(res => {
                            let cls = 'stage-badge';
                            if (currentResolution === res) cls += ' active';
                            else if (currentResolution) {
                                const currentIndex = stages.indexOf(currentResolution);
                                const resIndex = stages.indexOf(res);
                                if (resIndex < currentIndex) cls += ' completed';
                            }
                            return `<span class="${cls}" style="padding: 6px 12px;">${res}</span>`;
                        }).join('')}
                    </div>
                `;
            } else {
                currentProgressContainer.classList.add('hidden');
            }

            // Render all uploads list
            for (let [id, item] of activeUploads) {
                const stages = ['360p', '480p', '720p', '1080p'];
                const displayName = item.customName || item.filename;
                
                // Map stage to determine which resolution badge is active
                let currentResolution = null;
                if (item.stage && item.stage.includes('transcoding')) {
                    // Extract resolution from stage (e.g., "transcoding-360p" or "transcoding_360p")
                    const match = item.stage.match(/transcoding[-_](\d+p)/);
                    if (match) {
                        currentResolution = match[1];
                    }
                }
                
                const el = document.createElement('div');
                el.className = 'upload-item';
                el.innerHTML = `
                    <div class="upload-item-header">
                        <div>
                            <div class="upload-filename">${escapeHtml(displayName)}</div>
                            ${item.customName && item.customName !== item.filename ? 
                                `<div class="upload-status">File: ${escapeHtml(item.filename)}</div>` : ''}
                            <div class="upload-status">${escapeHtml(item.message)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${formatBytes(item.size)}</div>
                            <div class="upload-status">${item.stage}</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${item.progress}%">${item.progress}%</div>
                    </div>
                    <div class="upload-stages">
                        ${stages.map(res => {
                            let cls = 'stage-badge';
                            
                            // Check if this resolution is currently being transcoded
                            if (currentResolution === res) {
                                cls += ' active';
                            } 
                            // Check if this resolution was already completed
                            else if (currentResolution) {
                                const currentIndex = stages.indexOf(currentResolution);
                                const resIndex = stages.indexOf(res);
                                if (resIndex < currentIndex) {
                                    cls += ' completed';
                                }
                            }
                            // If transcode completed, mark all as completed
                            else if (item.stage === 'completed') {
                                cls += ' completed';
                            }
                            
                            return `<span class="${cls}">${res}</span>`;
                        }).join('')}
                        <span class="stage-badge ${item.stage === 'completed' ? 'completed' : item.stage === 'failed' ? 'failed' : ''}">
                            ${item.stage === 'completed' ? '‚úÖ Complete' : item.stage === 'failed' ? '‚ùå Failed' : '‚è≥ Pending'}
                        </span>
                    </div>
                `;
                container.appendChild(el);
            }
        }

        // Videos
        let currentView = 'grid';

        function switchVideoView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle .btn').forEach(b => b.classList.remove('active'));
            
            if (view === 'grid') {
                document.getElementById('btnGridView').classList.add('active');
                document.getElementById('videoGridView').classList.remove('hidden');
                document.getElementById('videoListView').classList.add('hidden');
            } else {
                document.getElementById('btnListView').classList.add('active');
                document.getElementById('videoGridView').classList.add('hidden');
                document.getElementById('videoListView').classList.remove('hidden');
            }
        }

        let videoCurrentPage = 1;
        let hasMoreVideos = false;
        let allLoadedVideos = [];

        async function loadVideos(loadMore = false) {
            try {
                const page = loadMore ? videoCurrentPage + 1 : 1;
                const res = await fetch(`/api/videos?page=${page}&limit=50&sort=uploadedAt&order=desc`);
                const data = await res.json();

                if (data.success) {
                    if (loadMore) {
                        allLoadedVideos = [...allLoadedVideos, ...data.data];
                    } else {
                        allLoadedVideos = data.data;
                    }
                    
                    videoCurrentPage = data.pagination?.page || 1;
                    hasMoreVideos = data.pagination?.hasMore || false;
                    
                    renderVideos(allLoadedVideos, hasMoreVideos);
                }
            } catch (e) {
                console.error('Failed to load videos:', e);
            }
        }

        function renderVideos(videos, showLoadMore = false) {
            const gridView = document.getElementById('videoGridView');
            const tableBody = document.getElementById('videoTableBody');

            // Grid view
            let gridHtml = videos.map(v => {
                const displayName = v.videoName || v.filename;
                const uploadDate = v.uploadedAt || v.createdAt;
                const presets = v.streams?.variants?.map(s => s.preset).join(', ') || 'N/A';
                return `
                <div class="video-card">
                    <div class="video-thumbnail">üé¨</div>
                    <div class="video-info">
                        <div class="video-title">${escapeHtml(displayName)}</div>
                        <div class="video-meta">‚è±Ô∏è ${formatDuration(v.metadata?.duration || v.duration || 0)}</div>
                        <div class="video-meta">üìÖ ${new Date(uploadDate).toLocaleDateString()}</div>
                        <div class="video-meta">
                            üì∫ ${presets}
                        </div>
                        <div class="video-actions">
                            <button class="btn btn-primary btn-sm" onclick="playVideo('${v.videoId}', '${escapeHtml(displayName)}')">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-secondary btn-sm" onclick="copyStreamUrl('${v.videoId}')">üìã URL</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteVideo('${v.videoId}', '${escapeHtml(displayName)}')" style="background: var(--error);">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;}).join('');
            
            // Add Load More button if there are more videos
            if (showLoadMore) {
                gridHtml += `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                        <button class="btn btn-primary" onclick="loadVideos(true)">üì• Load More Videos</button>
                    </div>
                `;
            }
            
            gridView.innerHTML = gridHtml;

            // Table view
            let tableHtml = videos.map(v => {
                const displayName = v.videoName || v.filename;
                const uploadDate = v.uploadedAt || v.createdAt;
                const presets = v.streams?.variants?.map(s => s.preset).join(', ') || 'N/A';
                return `
                <tr>
                    <td>${escapeHtml(displayName)}</td>
                    <td>${formatDuration(v.metadata?.duration || v.duration || 0)}</td>
                    <td>${presets}</td>
                    <td>${new Date(uploadDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="playVideo('${v.videoId}', '${escapeHtml(displayName)}')">‚ñ∂Ô∏è Play</button>
                        <button class="btn btn-secondary btn-sm" onclick="copyStreamUrl('${v.videoId}')">üìã URL</button>
                        <button class="btn btn-secondary btn-sm" onclick="deleteVideo('${v.videoId}', '${escapeHtml(displayName)}')" style="background: var(--error);">üóëÔ∏è</button>
                    </td>
                </tr>
            `;}).join('');
            
            // Add Load More row if there are more videos
            if (showLoadMore) {
                tableHtml += `
                    <tr>
                        <td colspan="5" style="text-align: center;">
                            <button class="btn btn-primary" onclick="loadVideos(true)">üì• Load More Videos</button>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHtml;
        }

        async function refreshVideos() {
            try {
                await fetch('/api/refresh-cache', { method: 'POST' });
                loadVideos();
                showAlert('Videos refreshed successfully', 'success');
            } catch (e) {
                showAlert('Failed to refresh videos', 'error');
            }
        }

        let currentVideoId = null;
        let currentVideoVariants = [];

        async function playVideo(videoId, filename) {
            try {
                const res = await fetch(`/api/video/${videoId}`);
                const data = await res.json();

                if (data.success && data.data.streams?.variants) {
                    currentVideoId = videoId;
                    currentVideoVariants = data.data.streams.variants;

                    const modal = document.getElementById('videoModal');
                    const player = document.getElementById('modalVideoPlayer');
                    const select = document.getElementById('modalQualitySelect');

                    document.getElementById('modalVideoTitle').textContent = filename;

                    select.innerHTML = currentVideoVariants.map(v => 
                        `<option value="${v.url}">${v.quality}</option>`
                    ).join('');

                    player.src = window.location.origin + currentVideoVariants[0].url;
                    modal.classList.add('show');
                }
            } catch (e) {
                showAlert('Failed to load video', 'error');
            }
        }

        function changeVideoQuality() {
            const select = document.getElementById('modalQualitySelect');
            const player = document.getElementById('modalVideoPlayer');
            const currentTime = player.currentTime;
            const wasPlaying = !player.paused;

            player.src = window.location.origin + select.value;
            player.currentTime = currentTime;
            if (wasPlaying) player.play();
        }

        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('modalVideoPlayer');
            player.pause();
            player.src = '';
            modal.classList.remove('show');
        }

        function copyStreamUrl(videoId) {
            const url = `${window.location.origin}/stream/${videoId}/720p.mp4`;
            navigator.clipboard.writeText(url).then(() => {
                showAlert('URL copied to clipboard!', 'success');
            });
        }

        async function deleteVideo(videoId, displayName) {
            if (!confirm(`Are you sure you want to delete "${displayName}"?\n\nThis will permanently remove:\n- Original upload file\n- All transcoded versions\n- Stream files\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const res = await authFetch(`/api/video/${videoId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    showAlert(`Video "${displayName}" deleted successfully`, 'success');
                    loadVideos(); // Refresh the list
                } else {
                    showAlert(data.message || 'Failed to delete video', 'error');
                }
            } catch (e) {
                showAlert('Failed to delete video: ' + e.message, 'error');
            }
        }

        // API Testing - Card-based functions
        async function showApiResponse(endpoint, options = {}) {
            const startTime = performance.now();
            try {
                const res = await authFetch(endpoint, options);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                const status = res.status;
                const statusText = res.statusText;

                const responseHeaders = {};
                res.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                let responseData;
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await res.json();
                } else {
                    responseData = await res.text();
                }

                const statusElement = document.getElementById('responseStatus');
                statusElement.textContent = status;
                statusElement.style.color = status >= 200 && status < 300 ? 'var(--success)' : 
                                           status >= 400 ? 'var(--error)' : 'var(--warning)';
                
                document.getElementById('responseStatusText').textContent = statusText;
                document.getElementById('responseTime').textContent = `${duration}ms`;
                document.getElementById('responseHeaders').textContent = JSON.stringify(responseHeaders, null, 2);
                
                if (typeof responseData === 'object') {
                    document.getElementById('responseBody').textContent = JSON.stringify(responseData, null, 2);
                } else {
                    document.getElementById('responseBody').textContent = responseData;
                }
                
                document.getElementById('apiResults').classList.remove('hidden');
                document.getElementById('apiResults').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                showAlert('Request failed: ' + e.message, 'error');
            }
        }

        // Videos API
        async function apiGetVideos() {
            const page = document.getElementById('api-videos-page').value || 1;
            const limit = document.getElementById('api-videos-limit').value || 50;
            await showApiResponse(`/api/videos?page=${page}&limit=${limit}`);
        }

        async function apiGetVideo() {
            const videoId = document.getElementById('api-video-id').value.trim();
            if (!videoId) {
                showAlert('Please enter a video ID', 'error');
                return;
            }
            await showApiResponse(`/api/video/${videoId}`);
        }

        async function apiDeleteVideo() {
            const videoId = document.getElementById('api-video-delete-id').value.trim();
            if (!videoId) {
                showAlert('Please enter a video ID', 'error');
                return;
            }
            if (!confirm(`Are you sure you want to delete video "${videoId}"?`)) {
                return;
            }
            await showApiResponse(`/api/video/${videoId}`, { method: 'DELETE' });
        }

        async function apiRefreshCache() {
            await showApiResponse('/api/refresh-cache', { method: 'POST' });
        }

        // Statistics & Health API
        async function apiGetStatistics() {
            await showApiResponse('/api/admin/statistics');
        }

        async function apiHealthCheck() {
            await showApiResponse('/health');
        }

        async function apiReadyCheck() {
            await showApiResponse('/ready');
        }

        async function apiLiveCheck() {
            await showApiResponse('/live');
        }

        // Logs API
        async function apiGetLogs() {
            const level = document.getElementById('api-logs-level').value;
            const search = document.getElementById('api-logs-search').value.trim();
            const limit = document.getElementById('api-logs-limit').value || 100;
            
            const params = new URLSearchParams();
            if (level) params.append('level', level);
            if (search) params.append('search', search);
            params.append('limit', limit);
            
            await showApiResponse(`/api/admin/logs?${params}`);
        }

        async function apiClearLogs() {
            if (!confirm('Are you sure you want to clear all logs?')) {
                return;
            }
            await showApiResponse('/api/admin/logs', { method: 'DELETE' });
        }

        // Configuration API
        async function apiGetConfig() {
            await showApiResponse('/api/admin/config');
        }

        async function apiTestConfig() {
            await showApiResponse('/api/admin/config/test', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
        }

        // Legacy API Testing
        function loadQuickEndpoint() {
            const select = document.getElementById('apiQuickSelect');
            const value = select.value;
            
            if (!value) return;

            const [method, endpoint] = value.split(':');
            document.getElementById('apiMethod').value = method;
            document.getElementById('apiEndpoint').value = endpoint;

            // Set default body for POST/PUT/PATCH
            if (['POST', 'PUT', 'PATCH'].includes(method)) {
                if (endpoint === '/api/upload') {
                    document.getElementById('apiBody').value = '// Use FormData for file uploads\n// This endpoint requires multipart/form-data';
                    document.getElementById('apiHeaders').value = JSON.stringify({}, null, 2);
                } else if (endpoint === '/api/admin/config') {
                    document.getElementById('apiBody').value = JSON.stringify({
                        "MAX_FILE_SIZE": 5368709120,
                        "ALLOWED_FORMATS": "mp4,mkv,avi,mov,wmv,flv,webm",
                        "ENABLE_TRANSCODING": true,
                        "TRANSCODING_PRESETS": "360p,480p,720p,1080p"
                    }, null, 2);
                } else {
                    document.getElementById('apiBody').value = JSON.stringify({}, null, 2);
                }
            } else {
                document.getElementById('apiBody').value = '';
            }

            select.value = '';
        }

        function clearApiTest() {
            document.getElementById('apiMethod').value = 'GET';
            document.getElementById('apiEndpoint').value = '/api/videos';
            document.getElementById('apiHeaders').value = '{}';
            document.getElementById('apiBody').value = '';
            document.getElementById('apiQuickSelect').value = '';
            document.getElementById('apiResults').classList.add('hidden');
        }

        async function executeApiTest() {
            const method = document.getElementById('apiMethod').value;
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            const headersText = document.getElementById('apiHeaders').value.trim();
            const bodyText = document.getElementById('apiBody').value.trim();
            
            if (!endpoint) {
                showAlert('Please enter an endpoint URL', 'error');
                return;
            }

            // Parse headers
            let headers = {};
            try {
                if (headersText) {
                    headers = JSON.parse(headersText);
                }
            } catch (e) {
                showAlert('Invalid JSON in headers', 'error');
                return;
            }

            // Parse body
            let body = null;
            if (['POST', 'PUT', 'PATCH'].includes(method) && bodyText) {
                try {
                    body = JSON.parse(bodyText);
                    headers['Content-Type'] = 'application/json';
                } catch (e) {
                    showAlert('Invalid JSON in request body', 'error');
                    return;
                }
            }

            const startTime = performance.now();

            try {
                const options = {
                    method,
                    headers
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const res = await authFetch(endpoint, options);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                const status = res.status;
                const statusText = res.statusText;

                // Get response headers
                const responseHeaders = {};
                res.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                // Try to parse as JSON, fallback to text
                let responseData;
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await res.json();
                } else {
                    responseData = await res.text();
                }

                // Display results
                const statusElement = document.getElementById('responseStatus');
                statusElement.textContent = status;
                statusElement.style.color = status >= 200 && status < 300 ? 'var(--success)' : 
                                           status >= 400 ? 'var(--error)' : 'var(--warning)';
                
                document.getElementById('responseStatusText').textContent = statusText;
                document.getElementById('responseTime').textContent = `${duration}ms`;
                document.getElementById('responseHeaders').textContent = JSON.stringify(responseHeaders, null, 2);
                
                if (typeof responseData === 'object') {
                    document.getElementById('responseBody').textContent = JSON.stringify(responseData, null, 2);
                } else {
                    document.getElementById('responseBody').textContent = responseData;
                }
                
                document.getElementById('apiResults').classList.remove('hidden');
            } catch (e) {
                showAlert('Request failed: ' + e.message, 'error');
                console.error('API Test Error:', e);
            }
        }

        // Statistics
        async function refreshStats() {
            try {
                const res = await authFetch('/api/admin/statistics');
                const data = await res.json();

                if (data.success) {
                    const { server, media, performance } = data.data;
                    
                    // Server stats
                    document.getElementById('statUptime').textContent = formatUptime(server.uptime || 0);
                    
                    const memUsedMB = (server.memoryUsage.usedSystemMemory / (1024 * 1024)).toFixed(1);
                    const memTotalGB = (server.memoryUsage.totalSystemMemory / (1024 * 1024 * 1024)).toFixed(1);
                    document.getElementById('statMemory').textContent = `${memUsedMB} MB / ${memTotalGB} GB`;

                    // Media stats
                    document.getElementById('statTotalVideos').textContent = media.totalVideos || 0;
                    document.getElementById('statActiveUploads').textContent = media.activeUploads || 0;
                    document.getElementById('statActiveTranscodes').textContent = media.activeTranscodes || 0;
                    document.getElementById('statActiveStreams').textContent = media.activeStreams || 0;
                    document.getElementById('statTotalStreams').textContent = media.totalStreamsServed || 0;
                    
                    const diskGB = (media.diskUsage / (1024 * 1024 * 1024)).toFixed(2);
                    document.getElementById('statDiskUsage').textContent = diskGB + ' GB';

                    // Performance stats
                    const avgUpload = performance.averageUploadTime > 0 
                        ? formatDuration(performance.averageUploadTime) 
                        : 'N/A';
                    document.getElementById('statAvgUpload').textContent = avgUpload;
                    
                    // Average transcode time (use first available quality)
                    const transcodeKey = Object.keys(performance.averageTranscodeTime)[0];
                    const avgTranscode = transcodeKey && performance.averageTranscodeTime[transcodeKey] > 0
                        ? formatDuration(performance.averageTranscodeTime[transcodeKey])
                        : 'N/A';
                    document.getElementById('statAvgTranscode').textContent = avgTranscode;
                }
            } catch (e) {
                showAlert('Failed to load statistics', 'error');
            }
        }

        function updateStatsDisplay(stats) {
            if (stats.totalVideos !== undefined) {
                document.getElementById('statTotalVideos').textContent = stats.totalVideos;
            }
            if (stats.activeUploads !== undefined) {
                document.getElementById('statActiveUploads').textContent = stats.activeUploads;
            }
            if (stats.activeStreams !== undefined) {
                document.getElementById('statActiveStreams').textContent = stats.activeStreams;
            }
            if (stats.diskUsage !== undefined) {
                const gb = (stats.diskUsage / (1024 * 1024 * 1024)).toFixed(2);
                document.getElementById('statDiskUsage').textContent = gb + ' GB';
            }
        }

        // Settings
        async function loadSettings() {
            try {
                const res = await authFetch('/api/admin/config');
                const data = await res.json();

                if (data.success) {
                    const config = data.data;
                    document.getElementById('settingUploadDir').value = config.VIDEO_UPLOAD_DIR || '';
                    document.getElementById('settingStreamDir').value = config.VIDEO_STREAM_DIR || '';
                    document.getElementById('settingMaxSize').value = config.MAX_FILE_SIZE || '';
                    document.getElementById('settingFormats').value = config.ALLOWED_FORMATS || '';
                    document.getElementById('settingPresets').value = config.TRANSCODING_PRESETS || '';
                    document.getElementById('settingEnableTranscoding').value = config.ENABLE_TRANSCODING || 'true';
                }
            } catch (e) {
                showAlert('Failed to load settings', 'error');
            }
        }

        async function saveSettings() {
            const config = {
                MAX_FILE_SIZE: parseInt(document.getElementById('settingMaxSize').value),
                ALLOWED_FORMATS: document.getElementById('settingFormats').value,
                TRANSCODING_PRESETS: document.getElementById('settingPresets').value,
                ENABLE_TRANSCODING: document.getElementById('settingEnableTranscoding').value === 'true'
            };

            try {
                const res = await authFetch('/api/admin/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                
                if (data.success) {
                    showAlert('Settings saved successfully', 'success');
                    // Show warnings if any
                    if (data.data && data.data.warnings && data.data.warnings.length > 0) {
                        data.data.warnings.forEach(warning => {
                            showAlert(warning, 'warning');
                        });
                    }
                } else {
                    showAlert(data.message || 'Failed to save settings', 'error');
                }
            } catch (e) {
                showAlert('Error saving settings: ' + e.message, 'error');
            }
        }

        // Test configuration without saving
        async function testConfiguration() {
            const config = {
                MAX_FILE_SIZE: parseInt(document.getElementById('settingMaxSize').value),
                ALLOWED_FORMATS: document.getElementById('settingFormats').value,
                TRANSCODING_PRESETS: document.getElementById('settingPresets').value,
                ENABLE_TRANSCODING: document.getElementById('settingEnableTranscoding').value === 'true'
            };

            const resultsContainer = document.getElementById('configValidationResults');
            resultsContainer.innerHTML = '<span style="color: var(--text-muted);">Testing configuration...</span>';
            resultsContainer.classList.remove('hidden');

            try {
                const res = await authFetch('/api/admin/config/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                
                if (data.success) {
                    let html = '';
                    
                    if (data.data.valid) {
                        html += '<div style="color: var(--success); margin-bottom: 10px;">‚úÖ Configuration is valid</div>';
                    } else {
                        html += '<div style="color: var(--error); margin-bottom: 10px;">‚ùå Configuration has errors</div>';
                    }
                    
                    if (data.data.errors && data.data.errors.length > 0) {
                        html += '<div style="margin-bottom: 10px;"><strong>Errors:</strong></div>';
                        html += '<ul style="color: var(--error); margin: 0; padding-left: 20px;">';
                        data.data.errors.forEach(err => {
                            html += `<li>${escapeHtml(err)}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (data.data.warnings && data.data.warnings.length > 0) {
                        html += '<div style="margin-bottom: 5px; margin-top: 10px;"><strong>Warnings:</strong></div>';
                        html += '<ul style="color: var(--warning); margin: 0; padding-left: 20px;">';
                        data.data.warnings.forEach(warn => {
                            html += `<li>${escapeHtml(warn)}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = `<span style="color: var(--error);">Test failed: ${escapeHtml(data.message || 'Unknown error')}</span>`;
                }
            } catch (e) {
                resultsContainer.innerHTML = `<span style="color: var(--error);">Error testing configuration: ${escapeHtml(e.message)}</span>`;
            }
        }

        // Logs
        async function loadLogs() {
            const level = document.getElementById('logLevelFilter').value;
            const search = document.getElementById('logSearch').value;
            
            const params = new URLSearchParams();
            if (level) params.append('level', level);
            if (search) params.append('search', search);
            params.append('limit', '100');

            try {
                const res = await authFetch(`/api/admin/logs?${params}`);
                const data = await res.json();

                if (data.success) {
                    renderLogs(data.data.logs || []);
                }
            } catch (e) {
                showAlert('Failed to load logs', 'error');
            }
        }

        function renderLogs(logs) {
            const container = document.getElementById('logContainer');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="text-muted text-center">No logs found</div>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level.toLowerCase()}">
                    <div class="log-timestamp">[${new Date(log.timestamp).toLocaleString()}] [${log.level}]</div>
                    <div>${escapeHtml(log.message)}</div>
                    ${log.metadata ? `<div class="text-muted" style="font-size: 10px; margin-top: 3px;">${escapeHtml(JSON.stringify(log.metadata))}</div>` : ''}
                </div>
            `).join('');
        }

        async function clearLogs() {
            if (!confirm('Clear all logs?')) return;

            try {
                const res = await authFetch('/api/admin/logs', { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadLogs();
                    showAlert('Logs cleared', 'success');
                }
            } catch (e) {
                showAlert('Failed to clear logs', 'error');
            }
        }

        // Utilities
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAlert(message, type = 'success') {
            const container = document.querySelector('.content-area');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.insertBefore(alert, container.firstChild);
            setTimeout(() => alert.remove(), 5000);
        }

        // Auto-refresh functionality
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            if (indicator) {
                indicator.style.animation = 'spin 0.5s linear';
                setTimeout(() => {
                    indicator.style.animation = '';
                }, 500);
            }
        }

        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Set up auto-refresh based on current page (every 10 seconds)
            autoRefreshInterval = setInterval(async () => {
                showRefreshIndicator();
                switch (currentPage) {
                    case 'videos':
                        await loadVideos();
                        break;
                    case 'statistics':
                        await refreshStats();
                        break;
                    case 'logs':
                        await loadLogs();
                        break;
                    case 'upload':
                        // Upload page uses Socket.IO for real-time updates
                        break;
                }
            }, 10000); // Refresh every 10 seconds
        }

        // Initial load
        loadVideos();
        startAutoRefresh();
    </script>
</body>
</html>
